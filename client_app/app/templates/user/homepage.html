{% extends "user/base.html" %}
{% block content %}
{% include 'user/navbar.html'%}
<div class="container mt-5 mb-5">
    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- Alert for validation errors -->
    <div class="alert alert-danger alert-dismissible fade show d-none" role="alert" id="validationAlert">
        <span id="validationMessage"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div class="card shadow border-0">
        <div class="card-header bg-primary text-white">
            <div class="d-flex align-items-center">
                <i class="bi bi-airplane-engines me-2"></i>
                <h5 class="mb-0">Tìm kiếm chuyến bay</h5>
            </div>
        </div>
        <div class="card-body">
            <form action="{{ url_for('homepage.search_flights') }}" method="POST" id="searchForm"
                class="needs-validation" novalidate>
                <div class="row mb-4">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <!-- Passenger Selection -->
                        <div class="position-relative">
                            <label class="form-label">Hành khách</label>
                            <div class="dropdown w-100">
                                <button
                                    class="btn btn-outline-secondary dropdown-toggle w-100 d-flex align-items-center justify-content-between"
                                    type="button" id="passengerButton" data-bs-toggle="dropdown" aria-expanded="false">
                                    <span>1 Người lớn, 0 Trẻ em, 0 Em bé</span>
                                    <i class="bi bi-person"></i>
                                </button>
                                <div class="dropdown-menu p-3" style="width: 300px;">
                                    <div class="mb-3">
                                        <label for="nguoiLon" class="form-label d-flex justify-content-between">
                                            <span>Người lớn</span>
                                            <small class="text-muted">(>12 tuổi)</small>
                                        </label>
                                        <div class="input-group">
                                            <input type="number" id="nguoiLon" name="nguoiLon"
                                                class="form-control text-center passenger-input" value="1" min="1"
                                                required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="treEm" class="form-label d-flex justify-content-between">
                                            <span>Trẻ em</span>
                                            <small class="text-muted">(2-12 tuổi)</small>
                                        </label>
                                        <div class="input-group">
                                            <input type="number" id="treEm" name="treEm"
                                                class="form-control text-center passenger-input" value="0" min="0"
                                                required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="emBe" class="form-label d-flex justify-content-between">
                                            <span>Em bé</span>
                                            <small class="text-muted">(<2 tuổi)</small>
                                        </label>
                                        <div class="input-group">
                                            <input type="number" id="emBe" name="emBe"
                                                class="form-control text-center passenger-input" value="0" min="0"
                                                required>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <!-- Seat Class -->
                        <label class="form-label">Hạng ghế</label>
                        <select class="form-select" name="seat_class">
                            {% for class in default_data.seat_class %}
                            <option value="{{ class.value }}">{{ class.label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6 mb-3">
                        <div class="row">
                            <!-- Origin -->
                            <div class="col-md-5">
                                <label class="form-label">Điểm đi</label>
                                <input type="hidden" name="origin" id="origin">
                                <div class="dropdown w-100">
                                    <button
                                        class="btn btn-outline-secondary dropdown-toggle w-100 d-flex align-items-center justify-content-between"
                                        type="button" id="originDropdownButton" data-bs-toggle="dropdown">
                                        <span>Chọn điểm đi</span>
                                        <i class="bi bi-geo-alt"></i>
                                    </button>
                                    <ul class="dropdown-menu w-100" id="origin-list">
                                        <li class="px-3">
                                            <input type="text" class="form-control" id="searchInputOrigin"
                                                placeholder="Tìm kiếm...">
                                        </li>
                                        <li>
                                            <hr class="dropdown-divider">
                                        </li>
                                        {% for sb in san_bay %}
                                        <li>
                                            <a class="dropdown-item" href="#"
                                                onclick="selectOrigin('{{sb.thanh_pho}} ({{sb.ma_san_bay}})', '{{sb.ma_san_bay}}')">
                                                {{sb.thanh_pho}} ({{sb.ma_san_bay}})
                                            </a>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>

                            <!-- Swap Button -->
                            <div class="col-md-2 d-flex align-items-center justify-content-center my-2">
                                <button class="btn btn-outline-primary rounded-circle p-2" type="button"
                                    id="swap-button">
                                    <i class="bi bi-arrow-left-right"></i>
                                </button>
                            </div>

                            <!-- Destination -->
                            <div class="col-md-5">
                                <label class="form-label">Điểm đến</label>
                                <input type="hidden" name="destination" id="destination">
                                <div class="dropdown w-100">
                                    <button
                                        class="btn btn-outline-secondary dropdown-toggle w-100 d-flex align-items-center justify-content-between"
                                        type="button" id="destinationDropdownButton" data-bs-toggle="dropdown">
                                        <span>Chọn điểm đến</span>
                                        <i class="bi bi-geo-alt"></i>
                                    </button>
                                    <ul class="dropdown-menu w-100" id="destination-list">
                                        <li class="px-3">
                                            <input type="text" class="form-control" id="searchInputDestination"
                                                placeholder="Tìm kiếm...">
                                        </li>
                                        <li>
                                            <hr class="dropdown-divider">
                                        </li>
                                        {% for sb in san_bay %}
                                        <li>
                                            <a class="dropdown-item" href="#"
                                                onclick="selectDestination('{{sb.thanh_pho}} ({{sb.ma_san_bay}})', '{{sb.ma_san_bay}}')">
                                                {{sb.thanh_pho}} ({{sb.ma_san_bay}})
                                            </a>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="row">
                            <!-- Departure Date -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ngày đi</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                                    <input type="date" id="departure-date" name="departure-date" class="form-control"
                                        value="{{ departure_date }}" min="{{ today_date }}" required>
                                </div>
                            </div>

                            <!-- Return Date -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ngày về</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                                    <input type="date" id="return-date" name="return-date" class="form-control"
                                        value="{{ return_date }}" min="{{ today_date }}" disabled>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Round Trip Checkbox -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="form-check float-end">
                            <input type="checkbox" name="return-trip" class="form-check-input" id="return-trip">
                            <label class="form-check-label" for="return-trip">Khứ hồi</label>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="d-grid">
                    <button class="btn btn-primary btn-lg" type="submit">
                        <i class="bi bi-search me-2"></i>Tìm kiếm chuyến bay
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% include 'user/footer.html'%}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Form validation
        const form = document.getElementById('searchForm');
        const validationAlert = document.getElementById('validationAlert');
        const validationMessage = document.getElementById('validationMessage');

        // Passenger input validation
        function validatePassengers() {
            const adults = parseInt(document.getElementById('nguoiLon').value) || 0;
            const infants = parseInt(document.getElementById('emBe').value) || 0;

            if (infants > adults) {
                validationAlert.classList.remove('d-none');
                validationMessage.textContent = 'Số em bé không được nhiều hơn số người lớn';
                return false;
            }

            validationAlert.classList.add('d-none');
            return true;
        }

        // Handle passenger increment/decrement
        document.querySelectorAll('.passenger-minus, .passenger-plus').forEach(button => {
            button.addEventListener('click', function () {
                const targetId = this.dataset.target;
                const input = document.getElementById(targetId);
                const currentValue = parseInt(input.value) || 0;
                const isPlus = this.classList.contains('passenger-plus');
                const minValue = parseInt(input.min) || 0;

                if (isPlus) {
                    input.value = currentValue + 1;
                } else {
                    input.value = Math.max(minValue, currentValue - 1);
                }

                // Update passenger summary
                updatePassengerSummary();
                validatePassengers();
            });
        });

        // Update passenger summary text
        function updatePassengerSummary() {
            const adults = document.getElementById('nguoiLon').value;
            const children = document.getElementById('treEm').value;
            const infants = document.getElementById('emBe').value;

            document.getElementById('passengerButton').querySelector('span').textContent =
                `${adults} Người lớn, ${children} Trẻ em, ${infants} Em bé`;
        }

        // Handle passenger input changes
        document.querySelectorAll('.passenger-input').forEach(input => {
            input.addEventListener('change', function () {
                const minValue = parseInt(this.min) || 0;
                this.value = Math.max(minValue, parseInt(this.value) || 0);
                updatePassengerSummary();
                validatePassengers();
            });
        });

        // Filter dropdowns
        function filterDropdown(inputId, dropdownId) {
            const input = document.getElementById(inputId);
            const filter = input.value.toLowerCase();
            const dropdownItems = document.querySelectorAll(`#${dropdownId} .dropdown-item`);

            dropdownItems.forEach(function (item) {
                const text = item.textContent || item.innerText;
                if (text.toLowerCase().indexOf(filter) > -1) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Location selection handlers
        window.selectOrigin = function (displayText, airportCode) {
            document.getElementById('originDropdownButton').querySelector('span').textContent = displayText;
            document.getElementById('origin').value = airportCode;
        }

        window.selectDestination = function (displayText, airportCode) {
            document.getElementById('destinationDropdownButton').querySelector('span').textContent = displayText;
            document.getElementById('destination').value = airportCode;
        }

        // Search input event listeners
        document.getElementById('searchInputOrigin').addEventListener('keyup', function () {
            filterDropdown('searchInputOrigin', 'origin-list');
        });

        document.getElementById('searchInputDestination').addEventListener('keyup', function () {
            filterDropdown('searchInputDestination', 'destination-list');
        });

        // Swap button handler
        document.getElementById('swap-button').addEventListener('click', function (e) {
            e.preventDefault();
            let originButton = document.getElementById('originDropdownButton').querySelector('span');
            let destinationButton = document.getElementById('destinationDropdownButton').querySelector('span');
            let originInput = document.getElementById('origin');
            let destinationInput = document.getElementById('destination');

            let tempText = originButton.textContent;
            let tempValue = originInput.value;

            originButton.textContent = destinationButton.textContent;
            originInput.value = destinationInput.value;

            destinationButton.textContent = tempText;
            destinationInput.value = tempValue;
        });

        // Return trip checkbox handler
        document.getElementById('return-trip').addEventListener('change', function () {
            const returnDateInput = document.getElementById('return-date');
            returnDateInput.disabled = !this.checked;

            if (this.checked) {
                const departureDate = document.getElementById('departure-date').value;
                returnDateInput.min = departureDate;
                if (!returnDateInput.value) {
                    returnDateInput.value = departureDate;
                }
            }
        });

        // Set min date for departure and handle date changes
        const today = new Date().toISOString().split('T')[0];
        const departureDate = document.getElementById('departure-date');
        const returnDate = document.getElementById('return-date');

        departureDate.min = today;
        departureDate.addEventListener('change', function () {
            if (document.getElementById('return-trip').checked) {
                returnDate.min = this.value;
                if (returnDate.value && returnDate.value < this.value) {
                    returnDate.value = this.value;
                }
            }
        });

        // Form submission handler
        form.addEventListener('submit', function (e) {
            if (!validatePassengers()) {
                e.preventDefault();
                return;
            }

            const origin = document.getElementById('origin').value;
            const destination = document.getElementById('destination').value;

            if (!origin || !destination) {
                e.preventDefault();
                validationAlert.classList.remove('d-none');
                validationMessage.textContent = 'Vui lòng chọn điểm đi và điểm đến';
                return;
            }

            if (origin === destination) {
                e.preventDefault();
                validationAlert.classList.remove('d-none');
                validationMessage.textContent = 'Điểm đi và điểm đến không được trùng nhau';
                return;
            }

            const departureDate = document.getElementById('departure-date').value;
            if (!departureDate) {
                e.preventDefault();
                validationAlert.classList.remove('d-none');
                validationMessage.textContent = 'Vui lòng chọn ngày đi';
                return;
            }

            if (document.getElementById('return-trip').checked) {
                const returnDate = document.getElementById('return-date').value;
                if (!returnDate) {
                    e.preventDefault();
                    validationAlert.classList.remove('d-none');
                    validationMessage.textContent = 'Vui lòng chọn ngày về';
                    return;
                }

                if (returnDate < departureDate) {
                    e.preventDefault();
                    validationAlert.classList.remove('d-none');
                    validationMessage.textContent = 'Ngày về phải sau ngày đi';
                    return;
                }
            }
        });

        // Initialize tooltips and popovers if using Bootstrap 5
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
{% endblock %}