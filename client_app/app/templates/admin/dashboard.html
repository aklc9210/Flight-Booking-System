{% extends 'admin/base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<style>
    .card {
        border-radius: 8px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .chart-container {
        position: relative;
        height: 300px;
        margin: 20px 0;
    }

    .stats-icon {
        font-size: 1.5rem;
        opacity: 0.8;
    }
</style>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <h3 class=" fw-bold"> Dashboard </h3>
        </div>
    </div>

    <div class="row mb-3">
        <!-- Weekly Revenue -->
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card">
                <div class="card-body" id="weeklyContainer">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="card-subtitle text-muted">Doanh thu tuần</h6>
                        <i class="fas fa-chart-line stats-icon text-primary"></i>
                    </div>
                    <h3 class="card-title mb-2" id="weeklyAmount">0 ₫</h3>
                    <p class="mb-0" id="weeklyGrowth"></p>
                </div>
            </div>
        </div>
        <!-- Monthly Revenue -->
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="card-subtitle text-muted">Doanh thu tháng</h6>
                        <i class="fas fa-calendar stats-icon text-info"></i>
                    </div>
                    <h3 class="card-title mb-2" id="monthlyRevenue">0 ₫</h3>
                    <p class="mb-0" id="monthlyOrders">0 đơn hàng</p>
                </div>
            </div>
        </div>
        <!-- Total Bookings -->
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="card-subtitle text-muted">Tổng số đặt chỗ hôm nay</h6>
                        <i class="fas fa-ticket-alt stats-icon text-success"></i>
                    </div>
                    <h3 class="card-title mb-2" id="totalBookings">0</h3>
                    <p class="mb-0" id="totalPassengers">0 vé bán ra</p>
                </div>
            </div>
        </div>


        <!-- Passengers -->
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="card-subtitle text-muted">Thống kê hành khách</h6>
                        <i class="fas fa-users stats-icon text-warning"></i>
                    </div>
                    <h3 class="card-title mb-2" id="passengerCount">0</h3>
                    <p class="mb-0" id="ratio">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title">Thị phần hãng hàng không</h5>
                        <div class="d-flex align-items-center">
                            <select id="timeFilter" class="form-select form-select-sm me-2" style="width: 150px;">
                                <option value="today">Hôm nay</option>
                                <option value="yesterday">Hôm qua</option>
                                <option value="last_7_days" selected>7 ngày qua</option>
                                <option value="last_14_days">14 ngày qua</option>
                                <option value="last_21_days">21 ngày qua</option>
                                <option value="last_month">1 tháng qua</option>
                            </select>
                            <button class="btn btn-sm btn-outline-primary d-flex align-items-center"
                                onclick="exportMarketShare()" id="exportBtn">
                                <span class="d-flex align-items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                        class="bi bi-clipboard-data" viewBox="0 0 16 16">
                                        <path
                                            d="M4 11a1 1 0 1 1 2 0v1a1 1 0 1 1-2 0zm6-4a1 1 0 1 1 2 0v5a1 1 0 1 1-2 0zM7 9a1 1 0 0 1 2 0v3a1 1 0 1 1-2 0z" />
                                        <path
                                            d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z" />
                                        <path
                                            d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z" />
                                    </svg>
                                    <span class="ms-1">Export</span>
                                </span>
                            </button>
                        </div>
                    </div>
                    <div id="marketShareContainer" class="chart-container">
                        <canvas id="marketShareChart"></canvas>
                    </div>
                </div>

            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="card-title mb-0">Xu hướng doanh thu</h5>
                        <div class="d-flex gap-2">
                            <select id="monthSelect" class="form-select form-select-sm" style="width: 110px;">
                                <option value="all">Tất cả</option>
                                <option value="1">Tháng 1</option>
                                <option value="2">Tháng 2</option>
                                <option value="3">Tháng 3</option>
                                <option value="4">Tháng 4</option>
                                <option value="5">Tháng 5</option>
                                <option value="6">Tháng 6</option>
                                <option value="7">Tháng 7</option>
                                <option value="8">Tháng 8</option>
                                <option value="9">Tháng 9</option>
                                <option value="10">Tháng 10</option>
                                <option value="11">Tháng 11</option>
                                <option value="12">Tháng 12</option>
                            </select>
                            <select id="yearSelect" class="form-select form-select-sm" style="width: 100px;">
                                <option value="all">Tất cả</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                            </select>
                            <button class="btn btn-sm btn-outline-primary ms-2" onclick="exportMonthlySales()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-clipboard-data" viewBox="0 0 16 16">
                                    <path
                                        d="M4 11a1 1 0 1 1 2 0v1a1 1 0 1 1-2 0zm6-4a1 1 0 1 1 2 0v5a1 1 0 1 1-2 0zM7 9a1 1 0 0 1 2 0v3a1 1 0 1 1-2 0z" />
                                    <path
                                        d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z" />
                                    <path
                                        d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z" />
                                </svg>
                                <span class="ms-1">Export</span>
                            </button>

                        </div>
                    </div>
                    <div id="monthlySalesContainer" class="chart-container">
                        <canvas id="monthlySalesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Charts Row -->
    <div class="row">
        <!-- Booking Stats -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title">Thống kê đặt chỗ</h5>
                        <div class="d-flex align-items-center gap-2">
                            <select id="bookingTimeRange" class="form-select form-select-sm me-2" style="width: 150px;">
                                <option value="last_7_days" selected>7 ngày qua</option>
                                <option value="last_14_days">14 ngày qua</option>
                                <option value="last_21_days">21 ngày qua</option>
                                <option value="last_month">1 tháng trước</option>
                                <option value="last_3_months">3 tháng trước</option>
                            </select>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportBookingStats()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-clipboard-data" viewBox="0 0 16 16">
                                    <path
                                        d="M4 11a1 1 0 1 1 2 0v1a1 1 0 1 1-2 0zm6-4a1 1 0 1 1 2 0v5a1 1 0 1 1-2 0zM7 9a1 1 0 0 1 2 0v3a1 1 0 1 1-2 0z" />
                                    <path
                                        d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z" />
                                    <path
                                        d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <!-- Thêm thông tin tổng quan -->
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <div class="text-muted small">Tổng đặt chỗ</div>
                                <div class="h5 mb-0" id="total_bookings">0</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <div class="text-muted small">Tổng vé bán ra</div>
                                <div class="h5 mb-0" id="total_tickets">0</div>
                            </div>
                        </div>
                    </div>
                    <!-- Container cho chart và loading/error states -->
                    <div id="bookingStatsContainer" class="chart-container position-relative">
                        <canvas id="bookingStatsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title">Thống kê dịch vụ hành lý</h5>
                        <div class="d-flex align-items-center gap-2">
                            <select id="baggageTimeRange" class="form-select form-select-sm me-2">
                                <option value="today">Hôm nay</option>
                                <option value="yesterday">Hôm qua</option>
                                <option value="last_7_days" selected>7 ngày qua</option>
                                <option value="last_14_days">14 ngày qua</option>
                                <option value="last_21_days">21 ngày qua</option>
                                <option value="last_month">1 tháng trước</option>
                                <option value="last_3_months">3 tháng trước</option>
                            </select>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportBaggageStats()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-clipboard-data" viewBox="0 0 16 16">
                                    <path
                                        d="M4 11a1 1 0 1 1 2 0v1a1 1 0 1 1-2 0zm6-4a1 1 0 1 1 2 0v5a1 1 0 1 1-2 0zM7 9a1 1 0 0 1 2 0v3a1 1 0 1 1-2 0z" />
                                    <path
                                        d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z" />
                                    <path
                                        d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <!-- Thêm thông tin tổng quan -->
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <div class="text-muted small">Tổng đơn hàng</div>
                                <div class="h5 mb-0" id="totalBaggageBookings">0</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <div class="text-muted small">Tổng doanh thu</div>
                                <div class="h5 mb-0" id="totalBaggageRevenue">0 ₫</div>
                            </div>
                        </div>
                    </div>
                    <div id="baggageStatsContainer" class="chart-container position-relative">
                        <canvas id="baggageStatsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% if session.user_info %}
<div id="tendangnhap" style="display: none;" value="{{ session.user_info.TenDangNhap }}"></div>
{% endif %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const tendangnhap = document.getElementById('tendangnhap').getAttribute('value');

    let marketShareChart = null;
    let monthlySalesChart = null;
    let bookingStatsChart = null;
    let baggageStatsChart = null;

    async function loadTodayBookingStats() {
        try {

            // Fetch data from the API
            const response = await fetch(`/dashboard/baggage_service_stats?time_range=today`);
            const data = await response.json();
            // Check if the response is successful
            if (data.status === 'success') {
                document.getElementById('totalBookings').textContent = data.data.total_bookings;
                document.getElementById('totalPassengers').textContent = `${data.data.total_passengers || 0} vé bán ra`;

            } else {
                console.error('Error fetching booking stats:', data.message);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function loadPassengers() {
        try {
            const response = await fetch('/dashboard/passengers');
            const data = await response.json();

            if (data.status === 'success') {
                const passengerCountElement = document.getElementById('passengerCount');
                const ratioElement = document.getElementById('ratio');

                // Hiển thị tổng số hành khách
                passengerCountElement.textContent = `${data.data.total_passengers}`;

                // Kiểm tra giá trị user_passenger_ratio
                const userPassengerRatio = data.data.user_passenger_ratio;
                ratioElement.textContent = `${userPassengerRatio}% tổng số người dùng`;

                // Thay đổi màu sắc dựa trên điều kiện
                if (userPassengerRatio < 0) {
                    ratioElement.classList.remove('text-success');
                    ratioElement.classList.add('text-danger');
                } else {
                    ratioElement.classList.remove('text-danger');
                    ratioElement.classList.add('text-success');
                }
            }
        } catch (error) {
            console.error('Error :', error);
        }
    }

    async function loadMarketShare() {
        try {
            showLoading('marketShareContainer');

            // Lấy giá trị từ dropdown
            const timeFilter = document.getElementById('timeFilter').value;

            // Gửi request với time filter
            const response = await fetch(`/dashboard/market-share?time=${timeFilter}`);
            const data = await response.json();

            const ctx = document.getElementById('marketShareChart').getContext('2d');
            const chartContainer = document.querySelector('.chart-container');

            // Kiểm tra trạng thái API
            if (data.status === 'success') {
                if (data.data.length > 0) {
                    // Hủy biểu đồ cũ nếu có
                    if (marketShareChart) {
                        marketShareChart.destroy();
                    }

                    // Tạo biểu đồ mới
                    marketShareChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: data.data.map(item => item.airline_name),
                            datasets: [{
                                data: data.data.map(item => item.market_share),
                                backgroundColor: [
                                    '#4e73df', '#1cc88a', '#36b9cc',
                                    '#f6c23e', '#e74a3b', '#858796'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '70%',
                            plugins: {
                                legend: {
                                    position: 'right'
                                }
                            }
                        }
                    });

                    // Đảm bảo xóa thông báo nếu trước đó không có dữ liệu
                    chartContainer.querySelector('.no-data-message')?.remove();
                } else {
                    // Hiển thị thông báo "Không có dữ liệu"
                    if (!chartContainer.querySelector('.no-data-message')) {
                        const noDataMessage = document.createElement('p');
                        noDataMessage.classList.add('no-data-message', 'text-center', 'text-muted');
                        noDataMessage.textContent = 'Không có dữ liệu';
                        chartContainer.appendChild(noDataMessage);
                    }

                    // Hủy biểu đồ cũ nếu có
                    if (marketShareChart) {
                        marketShareChart.destroy();
                        marketShareChart = null;
                    }
                }
            } else {
                console.error('Error fetching market share:', data.message);
            }
        } catch (error) {
            console.error('Error loading market share:', error);
        } finally {
            hideLoading('marketShareContainer');
        }
    }

    async function loadMonthlySales(month, year) {
        try {
            showLoading('monthlySalesContainer');

            const url = '/dashboard/revenue';
            const params = new URLSearchParams();

            // Lấy ngày hiện tại nếu không có giá trị month/year
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1; // Tháng hiện tại (0-11 nên cần +1)
            const currentYear = currentDate.getFullYear();

            // Sử dụng tháng và năm mặc định nếu không được truyền vào
            params.set('type', 'weekly'); // Weekly đầu tiên
            params.set('include_growth', 'true');
            params.set('month', month || currentMonth);
            params.set('year', year || currentYear);

            // Gọi API weekly
            const weeklyResponse = await fetch(`${url}?${params.toString()}`);
            const weeklyData = await weeklyResponse.json();

            // Gọi API monthly
            params.set('type', 'monthly'); // Sau đó chuyển sang monthly
            const monthlyResponse = await fetch(`${url}?${params.toString()}`);
            const monthlyData = await monthlyResponse.json();

            // ---------------- Xử lý weekly ----------------
            const weeklyContainer = document.getElementById('weeklyContainer');

            if (weeklyContainer) {
                // Xóa thông báo cũ (nếu có)
                weeklyContainer.querySelector('.no-data-message')?.remove();
                if (weeklyData.status === 'success' && weeklyData.data.length > 0) {
                    const weeklyItems = weeklyData.data;
                    const latestWeek = weeklyItems[weeklyItems.length - 1];

                    // Hiển thị doanh thu tuần gần nhất
                    document.getElementById('weeklyAmount').textContent = formatCurrency(latestWeek.total_revenue || 0);

                    const growthRate = latestWeek.growth_rate ?? 0; // Nếu không tồn tại, mặc định là 0
                    const growthElement = document.getElementById('weeklyGrowth');
                    const growthText = `${growthRate >= 0 ? '+' : ''}${growthRate}% so với tuần trước`;
                    growthElement.textContent = growthText;
                    growthElement.className = `mb-0 ${growthRate >= 0 ? 'text-success' : 'text-danger'}`;
                }
            }

            // ---------------- Xử lý monthly (vẽ chart) ----------------
            const monthlyContainer = document.getElementById('monthlySalesContainer');
            if (monthlyContainer) {
                // Xóa thông báo cũ (nếu có)
                monthlyContainer.querySelector('.no-data-message')?.remove();

                if (monthlyData.status === 'success' && monthlyData.data.length > 0) {
                    const monthlyItems = monthlyData.data;

                    const monthlyTotal = monthlyItems.reduce((sum, item) => sum + item.total_revenue, 0);
                    const monthlyOrders = monthlyItems.reduce((sum, item) => sum + item.total_orders, 0);

                    document.getElementById('monthlyRevenue').textContent = formatCurrency(monthlyTotal);
                    document.getElementById('monthlyOrders').textContent = `${monthlyOrders} đặt chỗ`;

                    const ctx = document.getElementById('monthlySalesChart').getContext('2d');
                    if (monthlySalesChart) {
                        monthlySalesChart.destroy();
                    }

                    // Vẽ biểu đồ
                    const labels = monthlyItems.map(i => {
                        const d = new Date(i.date || `${i.year}-${i.month || 1}-01`);
                        return `${d.getDate()}/${d.getMonth() + 1}`;
                    });
                    const chartData = monthlyItems.map(i => i.total_revenue);

                    monthlySalesChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Doanh thu',
                                data: chartData,
                                backgroundColor: '#4e73df',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: value => (value / 1000000)
                                    },
                                    title: {
                                        display: true,
                                        text: 'Doanh thu (triệu đồng)'
                                    }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: getRevenueChartTitle(month || currentMonth, year || currentYear)
                                }
                            }
                        }
                    });
                } else {
                    // Hiển thị thông báo "Không có dữ liệu"
                    document.getElementById('monthlyRevenue').textContent = '0';
                    document.getElementById('weeklyAmount').textContent = '0';
                    document.getElementById('monthlyOrders').textContent = 'Không có dữ liệu';
                    document.getElementById('weeklyGrowth').textContent = 'Không có dữ liệu';

                    const noDataMessage = document.createElement('p');
                    noDataMessage.classList.add('no-data-message', 'text-center', 'text-muted');
                    noDataMessage.textContent = 'Không có dữ liệu';
                    monthlyContainer.appendChild(noDataMessage);

                    // Hủy biểu đồ nếu có
                    if (monthlySalesChart) {
                        monthlySalesChart.destroy();
                        monthlySalesChart = null;
                    }
                }
            }
        } catch (error) {
            console.error('Error loading monthly sales:', error);
        } finally {
            hideLoading('monthlySalesContainer');
        }

    }

    async function loadBaggageStats() {
        try {
            showLoading('baggageStatsContainer');
            const timeRange = document.getElementById('baggageTimeRange').value;
            const response = await fetch(`/dashboard/baggage_service_stats?time_range=${timeRange}`);
            const data = await response.json();

            const baggageContainer = document.getElementById('baggageStatsContainer');
            if (baggageContainer) {
                // Xóa thông báo cũ (nếu có)
                baggageContainer.querySelector('.no-data-message')?.remove();
                if (data.status === 'success' && data.data.stats.length > 0) {
                    document.getElementById('totalBaggageBookings').textContent =
                        data.data.total_bookings.toLocaleString('vi-VN');
                    document.getElementById('totalBaggageRevenue').textContent =
                        formatCurrency(data.data.total_revenue);

                    const ctx = document.getElementById('baggageStatsChart').getContext('2d');

                    baggageStatsChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.data.stats.map(item => item.weight),
                            datasets: [{
                                label: 'Số lượng đơn',
                                data: data.data.stats.map(item => item.bookings),
                                backgroundColor: [
                                    '#4e73df', '#1cc88a', '#36b9cc',
                                    '#f6c23e', '#e74a3b', '#858796'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            const value = context.raw;
                                            const percentage = data.data.stats[context.dataIndex].percentage;
                                            const revenue = formatCurrency(data.data.stats[context.dataIndex].revenue);
                                            return [
                                                `Số lượng: ${value.toLocaleString('vi-VN')} đơn (${percentage}%)`,
                                                `Doanh thu: ${revenue}`
                                            ];
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: value => value.toLocaleString('vi-VN')
                                    },
                                    title: {
                                        display: true,
                                        text: 'Số lượng đơn'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Trọng lượng hành lý'
                                    }
                                }
                            }
                        }
                    });
                } else {
                    const noDataMessage = document.createElement('p');
                    noDataMessage.classList.add('no-data-message', 'text-center', 'text-muted');
                    noDataMessage.textContent = 'Không có dữ liệu';
                    baggageContainer.appendChild(noDataMessage);

                    // Hủy biểu đồ nếu có
                    if (baggageStatsChart) {
                        baggageStatsChart.destroy();
                        baggageStatsChart = null;
                    }
                }
            }
            else {
                showError('baggageStatsContainer', 'Không thể tải dữ liệu thống kê');
            }

        } catch (error) {
            console.error('Error:', error);
            showError('baggageStatsContainer', 'Đã có lỗi xảy ra');
        } finally {
            hideLoading('baggageStatsContainer');
        }
    }

    async function loadBookingStats() {
        try {
            showLoading('bookingStatsContainer');
            const timeRange = document.getElementById('bookingTimeRange').value;
            const response = await fetch(`/dashboard/booking-stats?time_range=${timeRange}`);
            const data = await response.json();
            const bookingStatsContainer = document.getElementById('bookingStatsContainer');
            if (bookingStatsContainer) {
                // Remove previous messages
                bookingStatsContainer.querySelector('.no-data-message')?.remove();

                if (data.status === 'success' && data.data.stats.length > 0) {
                    const stats = data.data.stats;
                    // Update total bookings and passengers
                    document.getElementById('total_bookings').textContent = data.data.total_bookings;
                    document.getElementById('total_tickets').textContent = `${data.data.total_passengers} vé bán ra`;

                    const ctx = document.getElementById('bookingStatsChart').getContext('2d');

                    // Destroy old chart if it exists
                    if (bookingStatsChart) {
                        bookingStatsChart.destroy();
                    }

                    // Create new chart
                    bookingStatsChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: stats.map(item => formatDate(item.date)),
                            datasets: [
                                {
                                    label: 'Số đặt chỗ',
                                    data: stats.map(item => item.total_bookings),
                                    borderColor: '#4e73df',
                                    backgroundColor: '#4e73df20',
                                    fill: true,
                                    tension: 0.4,
                                },
                                {
                                    label: 'Số vé bán ra',
                                    data: stats.map(item => item.total_passengers),
                                    borderColor: '#1cc88a',
                                    backgroundColor: '#1cc88a20',
                                    fill: true,
                                    tension: 0.4,
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: `Thống kê ${getPeriodLabel(timeRange).toLowerCase()}`,
                                },
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: value => value.toLocaleString('vi-VN'),
                                    },
                                    title: {
                                        display: true,
                                        text: 'Số lượng',
                                    },
                                },
                                x: {
                                    grid: {
                                        display: false,
                                    },
                                    title: {
                                        display: true,
                                        text: 'Ngày',
                                    },
                                },
                            },
                        },
                    });
                } else {
                    // Show no data message
                    const noDataMessage = document.createElement('p');
                    noDataMessage.classList.add('no-data-message', 'text-center', 'text-muted');
                    noDataMessage.textContent = 'Không có dữ liệu';
                    bookingStatsContainer.appendChild(noDataMessage);

                    // Destroy old chart if it exists
                    if (bookingStatsChart) {
                        bookingStatsChart.destroy();
                        bookingStatsChart = null;
                    }
                }
            } else {
                showError('bookingStatsContainer', 'Không thể tải dữ liệu thống kê');
            }
        } catch (error) {
            console.error('Error:', error);
            showError('bookingStatsContainer', 'Đã có lỗi xảy ra');
        } finally {
            hideLoading('bookingStatsContainer');
        }
    }


    // Initialize Dashboard
    document.addEventListener('DOMContentLoaded', async () => {
        // Set default values for month and year select boxes
        const currentDate = new Date();
        document.getElementById('monthSelect').value = currentDate.getMonth() + 1;
        document.getElementById('yearSelect').value = currentDate.getFullYear();

        // Load all initial data
        await Promise.all([
            loadMarketShare(),
            loadMonthlySales(),
            loadPassengers(),
            loadBookingStats(),
            loadBaggageStats(),
            loadTodayBookingStats()
        ]);

        // Add event listeners for monthly sales filters
        document.getElementById('monthSelect').addEventListener('change', () => {
            const month = parseInt(document.getElementById('monthSelect').value) || 'all';
            const year = parseInt(document.getElementById('yearSelect').value) || 'all';
            loadMonthlySales(month, year);
        });

        document.getElementById('yearSelect').addEventListener('change', () => {
            const month = parseInt(document.getElementById('monthSelect').value) || 'all';
            const year = parseInt(document.getElementById('yearSelect').value) || 'all';
            loadMonthlySales(month, year);
        });

        // Add event listener for market share time filter
        document.getElementById('timeFilter').addEventListener('change', loadMarketShare);

        // Add event listeners for booking stats
        const bookingTimeRangeSelect = document.getElementById('bookingTimeRange');
        if (bookingTimeRangeSelect) {
            bookingTimeRangeSelect.addEventListener('change', loadBookingStats);
        }

        // Add event listeners for baggage stats
        const baggageTimeRangeSelect = document.getElementById('baggageTimeRange');
        if (baggageTimeRangeSelect) {
            baggageTimeRangeSelect.addEventListener('change', loadBaggageStats);
        }

        // Auto refresh every 5 minutes
        setInterval(async () => {
            await Promise.all([
                loadMarketShare(),
                loadMonthlySales(),
                loadPassengers(),
                loadBookingStats(),
                loadBaggageStats(),
                loadTodayBookingStats()
            ]);
        }, 300000); // Refresh every 5 minutes
    });

    // Handle responsive resizing for charts
    window.addEventListener('resize', () => {
        if (bookingStatsChart) {
            bookingStatsChart.resize();
        }
        if (baggageStatsChart) {
            baggageStatsChart.resize();
        }
    });

</script>
<script src="{{url_for('static', filename='js/showloading.js')}}"></script>
<script src="{{url_for('static', filename='js/export_report.js')}}"></script>

{% endblock %}